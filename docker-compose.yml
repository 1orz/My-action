version: '3.8'

services:
  openwrt-builder:
    build:
      context: .
      dockerfile: Dockerfile
    image: openwrt-builder:latest
    container_name: openwrt-builder
    
    # 资源限制（可根据需要调整）
    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 16G
        reservations:
          cpus: '4'
          memory: 8G
    
    # 挂载卷
    volumes:
      # 配置文件目录
      - ./openwrt:/builder/configs:ro
      # 输出目录
      - ./output:/builder/output:rw
      # OpenWrt 源码（持久化）
      - openwrt-src:/builder/openwrt:rw
      # ccache 缓存（加速编译）
      - ccache-data:/builder/.ccache:rw
      # 构建脚本
      - ./build.sh:/builder/build.sh:ro
    
    # 环境变量
    environment:
      - TZ=Asia/Shanghai
      - USE_CCACHE=1
      - CCACHE_DIR=/builder/.ccache
    
    # 使用主机网络（加速下载）
    network_mode: "host"
    
    # 保持容器运行
    tty: true
    stdin_open: true
    
    # 工作目录
    working_dir: /builder
    
    # 默认命令
    command: /bin/bash

volumes:
  openwrt-src:
    name: openwrt-src
  ccache-data:
    name: ccache-data

